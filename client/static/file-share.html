<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArkFile - File Sharing</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .hidden { display: none; }
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .share-link {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #007bff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .security-notice {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9em;
        }
        .share-item {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
            padding: 15px;
        }
        .share-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ArkFile</h1>
            <nav>
                <a href="/">Home</a>
                <a href="#" id="logoutBtn">Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <h2>File Sharing</h2>
        <p>Create secure, password-protected share links.</p>

        <div class="card">
            <h3>File Information</h3>
            <div id="fileInfo">Loading...</div>
        </div>

        <div id="createShareSection" class="card">
            <h3>Create New Share Link</h3>
            <form id="shareForm">
                <div class="form-group">
                    <label for="sharePassword">Share Password (Required):</label>
                    <input type="password" id="sharePassword" required>
                    <p class="helper-text">This password will be required to access the file. You must share it with the recipient securely.</p>
                </div>
                <div class="form-group">
                    <label for="confirmSharePassword">Confirm Password:</label>
                    <input type="password" id="confirmSharePassword" required>
                </div>
                <div class="form-group">
                    <label for="expiryHours">Expire After:</label>
                    <select id="expiryHours">
                        <option value="24">1 Day</option>
                        <option value="72">3 Days</option>
                        <option value="168">1 Week</option>
                        <option value="720">30 Days</option>
                        <option value="0">Never</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn primary">Create Share Link</button>
                </div>
            </form>
        </div>

        <div id="shareResult" class="card hidden">
            <h3>Share Link Created</h3>
            <p>Your file is now shared with the following link:</p>
            <div class="share-link" id="shareUrl"></div>
            
            <div class="security-notice">
                <strong>Important:</strong> The recipient will need the <strong>Share Password</strong> you just set to access this file.
            </div>
            
            <p>
                <button id="copyShareLink" class="btn secondary">Copy Link</button>
                <button id="createAnother" class="btn primary">Create Another</button>
            </p>
        </div>

        <div class="card">
            <h3>Active Shares</h3>
            <div id="sharesList">
                <p>Loading...</p>
            </div>
        </div>
        
        <div class="actions">
            <a href="/" class="btn secondary">Back to Files</a>
        </div>
    </main>

    <!-- Decryption Password Modal -->
    <div id="decryptionModal" class="modal hidden">
        <div class="modal-content">
            <h3>Enter Decryption Password</h3>
            <p>To create a share, we need to decrypt the file key first. Please enter the password used to encrypt this file (usually your account password).</p>
            <form id="decryptionForm">
                <div class="form-group">
                    <label for="decryptionPassword">Password:</label>
                    <input type="password" id="decryptionPassword" required>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelDecryption" class="btn secondary">Cancel</button>
                    <button type="submit" class="btn primary">Unlock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Compiled TypeScript application -->
    <script src="/js/libopaque.js"></script>
    <script src="/js/dist/app.js"></script>
    <script>
        // Constants and globals
        const fileId = new URLSearchParams(window.location.search).get('file');
        let fileData = null;
        let activeShares = [];
        
        // DOM ready handler
        document.addEventListener('DOMContentLoaded', async () => {
            if (!fileId) {
                window.location.href = '/';
                return;
            }
            
            // Wait for modules to load
            await waitForModules();
            
            // Initialize UI
            setupEventListeners();
            await loadFileData();
            await loadShares();
        });
        
        // Wait for dynamic imports in app.js to complete
        async function waitForModules() {
            return new Promise(resolve => {
                const check = () => {
                    if (window.arkfile && window.arkfile.shares && window.arkfile.encryption && window.arkfile.auth) {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }
        
        // Load file data
        async function loadFileData() {
            try {
                const response = await fetch(`/api/files/${fileId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load file data');
                }
                
                fileData = await response.json();
                updateFileInfo();
            } catch (error) {
                showError('Error loading file data: ' + error.message);
            }
        }
        
        // Load active shares
        async function loadShares() {
            try {
                const response = await fetch('/api/user/shares', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load shares');
                }
                
                const data = await response.json();
                // Filter shares for current file
                activeShares = (data.shares || []).filter(share => share.fileId === fileId);
                
                updateSharesList();
            } catch (error) {
                showError('Error loading shares: ' + error.message);
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Share form submission
            document.getElementById('shareForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleCreateShare();
            });
            
            // Copy link
            document.getElementById('copyShareLink').addEventListener('click', () => {
                const shareLink = document.getElementById('shareUrl').textContent;
                navigator.clipboard.writeText(shareLink)
                    .then(() => alert('Share link copied to clipboard'))
                    .catch(err => console.error('Failed to copy link', err));
            });
            
            // Create another
            document.getElementById('createAnother').addEventListener('click', () => {
                document.getElementById('shareResult').classList.add('hidden');
                document.getElementById('createShareSection').classList.remove('hidden');
                document.getElementById('shareForm').reset();
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                window.arkfile.auth.logout().then(() => {
                    window.location.href = '/';
                });
            });
            
            // Decryption modal
            document.getElementById('cancelDecryption').addEventListener('click', () => {
                document.getElementById('decryptionModal').classList.add('hidden');
            });
        }
        
        // Handle share creation
        async function handleCreateShare() {
            const sharePassword = document.getElementById('sharePassword').value;
            const confirmPassword = document.getElementById('confirmSharePassword').value;
            const expiryHours = parseInt(document.getElementById('expiryHours').value, 10);
            
            if (sharePassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            // Validate password strength
            const ShareCreator = window.arkfile.shares.ShareCreator;
            // Create a dummy instance to access validatePassword
            const dummyCreator = new ShareCreator({ filename: '', fek: new Uint8Array(0) });
            const validation = await dummyCreator.validatePassword(sharePassword);
            
            if (!validation.meets_requirements) {
                alert('Password is too weak: ' + validation.feedback.join('. '));
                return;
            }
            
            try {
                // Get FEK (File Encryption Key)
                let fek = await getFileEncryptionKey();
                
                if (!fek) {
                    // Prompt for password if not cached
                    fek = await promptForDecryptionPassword();
                    if (!fek) return; // User cancelled
                }
                
                // Show loading
                const submitBtn = document.querySelector('#shareForm button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.innerHTML = '<span class="spinner"></span> Creating...';
                submitBtn.disabled = true;
                
                // Create share
                const creator = new ShareCreator({
                    filename: fileData.filename,
                    fek: fek
                });
                
                const result = await creator.createShare({
                    fileId: fileId,
                    sharePassword: sharePassword,
                    expiresAfterHours: expiryHours
                });
                
                if (result.success) {
                    // Show result
                    document.getElementById('shareUrl').textContent = result.shareUrl;
                    document.getElementById('createShareSection').classList.add('hidden');
                    document.getElementById('shareResult').classList.remove('hidden');
                    
                    // Reload shares list
                    await loadShares();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                showError('Error creating share: ' + error.message);
            } finally {
                // Restore button
                const submitBtn = document.querySelector('#shareForm button[type="submit"]');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Get FEK from cache or return null
        async function getFileEncryptionKey() {
            const fileEncryption = window.arkfile.encryption.fileEncryption;
            return fileEncryption.getCachedFileEncryptionKey(fileId);
        }
        
        // Prompt user for password to decrypt FEK
        function promptForDecryptionPassword() {
            return new Promise((resolve) => {
                const modal = document.getElementById('decryptionModal');
                const form = document.getElementById('decryptionForm');
                const input = document.getElementById('decryptionPassword');
                
                modal.classList.remove('hidden');
                input.value = '';
                input.focus();
                
                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const password = input.value;
                    
                    try {
                        const fileEncryption = window.arkfile.encryption.fileEncryption;
                        // Attempt to derive key
                        const fek = await fileEncryption.deriveFileEncryptionKeyWithCache(
                            fileId,
                            password,
                            fileData.salt // Assuming fileData has salt, need to verify API response
                        );
                        
                        if (fek) {
                            modal.classList.add('hidden');
                            cleanup();
                            resolve(fek);
                        } else {
                            alert('Incorrect password or failed to derive key.');
                        }
                    } catch (error) {
                        console.error(error);
                        alert('Error deriving key: ' + error.message);
                    }
                };
                
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(null);
                };
                
                const cleanup = () => {
                    form.removeEventListener('submit', handleSubmit);
                    document.getElementById('cancelDecryption').removeEventListener('click', handleCancel);
                };
                
                form.addEventListener('submit', handleSubmit);
                document.getElementById('cancelDecryption').addEventListener('click', handleCancel);
            });
        }
        
        // Update file info display
        function updateFileInfo() {
            if (!fileData) return;
            
            const fileInfoEl = document.getElementById('fileInfo');
            fileInfoEl.innerHTML = `
                <strong>Filename:</strong> ${escapeHtml(fileData.filename)}<br>
                <strong>Size:</strong> ${fileData.size_readable}<br>
                <strong>Uploaded:</strong> ${new Date(fileData.uploadDate).toLocaleString()}
            `;
        }
        
        // Update shares list display
        function updateSharesList() {
            const sharesListEl = document.getElementById('sharesList');
            
            if (!activeShares || activeShares.length === 0) {
                sharesListEl.innerHTML = '<p>No active shares for this file.</p>';
                return;
            }
            
            let html = '';
            
            activeShares.forEach(share => {
                // Determine status
                let statusText = 'Active';
                let statusClass = 'status-active';
                
                if (share.revoked_at) {
                    statusText = `Revoked (${share.revoked_reason || 'manual'})`;
                    statusClass = 'status-revoked';
                } else if (share.expiresAt && new Date(share.expiresAt) < new Date()) {
                    statusText = 'Expired';
                    statusClass = 'status-expired';
                }
                
                // Format download count
                let downloadInfo = '';
                if (share.max_accesses) {
                    downloadInfo = `${share.access_count || 0} / ${share.max_accesses} downloads`;
                } else {
                    downloadInfo = `${share.access_count || 0} downloads (unlimited)`;
                }
                
                html += `
                    <div class="share-item ${statusClass}">
                        <div class="share-link">${share.shareUrl}</div>
                        <div>
                            <strong>Status:</strong> <span class="${statusClass}">${statusText}</span><br>
                            <strong>Downloads:</strong> ${downloadInfo}<br>
                            <strong>Created:</strong> ${new Date(share.createdAt).toLocaleString()}<br>
                            ${share.expiresAt ? `<strong>Expires:</strong> ${new Date(share.expiresAt).toLocaleString()}<br>` : ''}
                            ${share.lastAccessed ? `<strong>Last Accessed:</strong> ${new Date(share.lastAccessed).toLocaleString()}<br>` : ''}
                        </div>
                        <div class="share-actions">
                            <button class="btn secondary sm" onclick="navigator.clipboard.writeText('${share.shareUrl}')">Copy Link</button>
                            ${!share.revoked_at ? `<button class="btn warning sm" onclick="revokeShare('${share.id}')">Revoke</button>` : ''}
                            <button class="btn danger sm" onclick="deleteShare('${share.id}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            sharesListEl.innerHTML = html;
        }
        
        // Revoke a share
        async function revokeShare(shareId) {
            if (!confirm('Are you sure you want to revoke this share link? It will no longer be accessible.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/shares/${shareId}/revoke`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: 'owner_revoked' })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to revoke share');
                }
                
                await loadShares();
                alert('Share link revoked successfully');
            } catch (error) {
                showError('Error revoking share: ' + error.message);
            }
        }
        
        // Delete a share
        async function deleteShare(shareId) {
            if (!confirm('Are you sure you want to delete this share link?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/share/${shareId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete share');
                }
                
                await loadShares();
                alert('Share link deleted successfully');
            } catch (error) {
                showError('Error deleting share: ' + error.message);
            }
        }
        
        function showError(message) {
            alert(message);
            console.error(message);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
