# OPAQUE Authentication System Fixes

**Status:** Implementation Document  
**Created:** 2025-11-07  
**Purpose:** Document all changes needed to establish a logically cohesive OPAQUE authentication system

## Executive Summary

This is a greenfield application with no production deployments. The current OPAQUE implementation is functionally correct but contains artifacts that create confusion around the "session key" concept. This document outlines all necessary changes to align the implementation with RFC 9497, remove deprecated code, and establish clean separation of concerns.

**Approach:** Complete cleanup with no backwards compatibility concerns. Remove all broken/deprecated functions entirely.

## Current Issues

### 1. Export Key Misuse
- **Problem:** The OPAQUE export key is being converted to a "session key" but never actually used
- **Impact:** Cryptographic material left in memory unnecessarily
- **Security Risk:** Low (not transmitted), but violates principle of minimal exposure

### 2. Confusing Terminology
- **Problem:** The term "session key" is used for the OPAQUE export key, but JWT tokens handle sessions
- **Impact:** Code is confusing and misleading for future developers
- **Security Risk:** None, but increases maintenance burden

### 3. Unused Interface Fields
- **Problem:** TypeScript interfaces define `session_key` field that server never returns
- **Impact:** Type definitions don't match actual API responses
- **Security Risk:** None, but creates confusion

## How OPAQUE Should Work

### The Three Key Components

#### 1. OPAQUE Export Key (Client-Side Only)
```
Purpose: Optional application-specific cryptography
Location: Generated on client during OPAQUE finalization
Transmission: NEVER sent to server
Usage: Either use immediately for crypto operations OR discard
Security: Cannot be used to derive password (one-way)
```

#### 2. JWT Tokens (Session Management)
```
Purpose: Manage authenticated sessions
Location: Generated by server, stored on client
Transmission: Sent to server in Authorization header
Usage: Authorize all API requests
Security: Signed by server, can be revoked, time-limited
```

#### 3. No "Session Key" Concept
```
The export key is NOT a session key
JWT tokens ARE the session mechanism
Remove all references to "session key"
```

### Correct OPAQUE Flow

#### Registration:
```
1. Client: password → OPAQUE → registration_request
2. Server: registration_request → registration_response
3. Client: registration_response → registration_record + export_key
4. Client: DISCARD export_key (if not needed)
5. Client: Send registration_record to server
6. Server: Store record, issue JWT tokens
7. Client: Store JWT tokens for session management
```

#### Login:
```
1. Client: password → OPAQUE → credential_request
2. Server: credential_request → credential_response
3. Client: credential_response → auth_token + session_key (export key)
4. Client: DISCARD session_key (if not needed)
5. Client: Send auth_token to server
6. Server: Verify auth_token, issue JWT tokens
7. Client: Store JWT tokens for session management
```

## Required Changes

### File 1: `client/static/js/src/auth/register.ts`

#### Change 1.1: Remove Export Key → Session Key Conversion
**Location:** Lines 82-84

**Current Code:**
```typescript
// Derive session key from export key (not sent by server)
// The export key is ephemeral and used only for session derivation
const sessionKeyBase64 = btoa(String.fromCharCode(...registrationFinalize.exportKey));
```

**New Code:**
```typescript
// Discard export key immediately (not needed for this application)
// JWT tokens handle all session management
if (registrationFinalize.exportKey) {
  registrationFinalize.exportKey.fill(0);
}
```

**Rationale:** Export key serves no purpose in this application. JWT tokens handle sessions. Discard immediately to minimize exposure.

#### Change 1.2: Update completeRegistration Call
**Location:** Lines 86-91

**Current Code:**
```typescript
await this.completeRegistration({
  token: registrationData.token,
  refresh_token: registrationData.refresh_token,
  session_key: sessionKeyBase64,
  auth_method: 'OPAQUE'
}, credentials.username);
```

**New Code:**
```typescript
await this.completeRegistration({
  token: registrationData.token,
  refresh_token: registrationData.refresh_token,
  auth_method: 'OPAQUE'
}, credentials.username);
```

**Rationale:** Remove unused session_key parameter.

#### Change 1.3: Update RegistrationResponse Interface
**Location:** Lines 11-16

**Current Code:**
```typescript
export interface RegistrationResponse {
  token: string;
  refresh_token: string;
  session_key: string;
  auth_method: 'OPAQUE';
}
```

**New Code:**
```typescript
export interface RegistrationResponse {
  token: string;
  refresh_token: string;
  auth_method: 'OPAQUE';
}
```

**Rationale:** Server never returns session_key. Interface should match actual API response.

### File 2: `client/static/js/src/auth/login.ts`

#### Change 2.1: Remove Session Key → Base64 Conversion
**Location:** Lines 95-96

**Current Code:**
```typescript
// Convert session key to base64 for storage
const sessionKeyBase64 = btoa(String.fromCharCode(...loginFinalize.sessionKey));
```

**New Code:**
```typescript
// Discard session key immediately (not needed for this application)
// JWT tokens handle all session management
if (loginFinalize.sessionKey) {
  loginFinalize.sessionKey.fill(0);
}
```

**Rationale:** Session key (export key) serves no purpose. Discard immediately.

#### Change 2.2: Update TOTP Flow Call
**Location:** Lines 99-104

**Current Code:**
```typescript
if (loginData.requires_totp) {
  hideProgress();
  // Convert session key to base64 for TOTP flow
  const sessionKeyBase64 = btoa(String.fromCharCode(...loginFinalize.sessionKey));
  handleTOTPFlow({
    tempToken: loginData.temp_token!,
    sessionKey: sessionKeyBase64,
    username: credentials.username
  });
  return;
}
```

**New Code:**
```typescript
if (loginData.requires_totp) {
  hideProgress();
  handleTOTPFlow({
    tempToken: loginData.temp_token!,
    username: credentials.username
  });
  return;
}
```

**Rationale:** TOTP flow doesn't need session key. JWT tokens handle sessions.

#### Change 2.3: Update completeLogin Call
**Location:** Lines 103-108

**Current Code:**
```typescript
await this.completeLogin({
  token: loginData.token,
  refresh_token: loginData.refresh_token,
  session_key: sessionKeyBase64,
  auth_method: 'OPAQUE'
}, credentials.username);
```

**New Code:**
```typescript
await this.completeLogin({
  token: loginData.token,
  refresh_token: loginData.refresh_token,
  auth_method: 'OPAQUE'
}, credentials.username);
```

**Rationale:** Remove unused session_key parameter.

#### Change 2.4: Update LoginResponse Interface
**Location:** Lines 13-20

**Current Code:**
```typescript
export interface LoginResponse {
  token: string;
  refresh_token: string;
  session_key: string;
  auth_method: 'OPAQUE';
  requires_totp?: boolean;
  temp_token?: string;
}
```

**New Code:**
```typescript
export interface LoginResponse {
  token: string;
  refresh_token: string;
  auth_method: 'OPAQUE';
  requires_totp?: boolean;
  temp_token?: string;
}
```

**Rationale:** Server never returns session_key. Interface should match actual API response.

### File 3: `client/static/js/src/auth/totp.ts`

#### Change 3.1: Update handleTOTPFlow Function Signature
**Location:** Function definition (need to verify exact line)

**Current Code:**
```typescript
export function handleTOTPFlow(data: {
  tempToken: string;
  sessionKey: string;
  username: string;
}): void
```

**New Code:**
```typescript
export function handleTOTPFlow(data: {
  tempToken: string;
  username: string;
}): void
```

**Rationale:** TOTP flow doesn't need session key. Remove unused parameter.

#### Change 3.2: Remove Any Session Key Usage
**Action:** Search for any references to `sessionKey` in the file and remove them.

**Rationale:** Session key is not part of TOTP flow.

### File 4: `handlers/auth.go`

#### Change 4.1: Remove Misleading Comments
**Location:** Lines 332-340 (approximately)

**Current Code:**
```go
// For multi-step OPAQUE, we don't have the export key available
// The session key will need to be derived on the client side from the export key
// that the client obtained during the OPAQUE protocol
// So we don't return a session_key here - the client already has it
```

**New Code:**
```go
// Multi-step OPAQUE protocol complete
// JWT tokens handle all session management
// The OPAQUE export key (if generated) remains client-side and is not used by the server
```

**Rationale:** Clarify that JWT tokens handle sessions, not OPAQUE export key.

## Security Verification Checklist

### ✅ Verify These Security Properties:

1. **Password Never Transmitted**
   - [ ] Registration: password stays on client
   - [ ] Login: password stays on client
   - [ ] No password in any network request

2. **Export Key Never Transmitted**
   - [ ] Registration: export key generated on client, never sent
   - [ ] Login: session key (export key) generated on client, never sent
   - [ ] No export/session key in any network request

3. **JWT Tokens Handle Sessions**
   - [ ] Access token used for authenticated requests
   - [ ] Refresh token used to get new access tokens
   - [ ] Tokens can be revoked
   - [ ] Tokens have appropriate expiration times

4. **TOTP Independent**
   - [ ] TOTP secrets stored server-side (encrypted)
   - [ ] TOTP validation independent of OPAQUE
   - [ ] TOTP provides true second factor

5. **No Cryptographic Material Left in Memory**
   - [ ] Export key discarded after OPAQUE finalization
   - [ ] Client secrets cleared from sessionStorage
   - [ ] No unused keys lingering in JavaScript memory

## Compilation Verification

After making changes, verify code compiles correctly:

### TypeScript Compilation
```bash
cd client/static/js
npm run build
```

**Expected:** No TypeScript compilation errors

### Go Compilation
```bash
go build -o /tmp/arkfile-test ./...
```

**Expected:** No Go compilation errors

### C Library (if modified)
```bash
cd auth
gcc -c opaque_wrapper.c -o /tmp/opaque_wrapper.o
```

**Expected:** No C compilation errors

## Code Quality Checks

### TypeScript Linting
```bash
cd client/static/js
npm run lint
```

### Go Formatting
```bash
go fmt ./...
```

### Go Vet
```bash
go vet ./...
```

## Implementation Order

1. **Phase 1: Documentation** ✅
   - [x] Create this document

2. **Phase 2: TypeScript Changes**
   - [ ] Update `RegistrationResponse` interface (remove session_key)
   - [ ] Update `LoginResponse` interface (remove session_key)
   - [ ] Update `handleTOTPFlow` function signature (remove sessionKey param)
   - [ ] Add export key disposal in `register.ts`
   - [ ] Add session key disposal in `login.ts`
   - [ ] Remove session key derivation from both files
   - [ ] Remove session_key from `completeRegistration` call
   - [ ] Remove session_key from `completeLogin` call
   - [ ] Remove session_key from TOTP flow
   - [ ] Verify TypeScript compiles: `npm run build`

3. **Phase 3: Go Backend Cleanup**
   - [ ] Update comments in `handlers/auth.go`
   - [ ] Remove any session_key references in Go code
   - [ ] Verify Go compiles: `go build ./...`

4. **Phase 4: Code Quality**
   - [ ] Run `go fmt ./...`
   - [ ] Run `go vet ./...`
   - [ ] Run TypeScript linter if available
   - [ ] Review all changes for consistency

5. **Phase 5: Documentation**
   - [ ] Update `docs/security.md` if needed
   - [ ] Update `docs/api.md` if needed
   - [ ] Mark this document as complete

## References

- **RFC 9497:** OPAQUE Protocol Specification
- **Current Implementation:** `auth/opaque_multi_step.go`
- **JWT Implementation:** `auth/jwt.go`
- **TOTP Implementation:** `auth/totp.go`

## Notes

- **Greenfield Application:** No production deployments, no backwards compatibility needed
- **Clean Slate Approach:** Remove all deprecated/broken code entirely
- **Focus:** Correct, clean, compilable code across frontend and backend
- **Out of Scope:** Testing scripts (dev-reset.sh, security-test-suite.sh, test-app-curl.sh) - will be refactored separately
- **Out of Scope:** End-to-end testing, functional testing, manual browser testing - focus on code correctness first
- The OPAQUE protocol implementation is correct
- The JWT token management is correct
- The TOTP implementation is correct
- The only issue is the unused "session key" concept
- This is a cleanup/clarification task, not a security fix
- No breaking changes to API or database schema

## Conclusion

These changes will:
1. Remove confusing "session key" terminology completely
2. Properly discard OPAQUE export key immediately after use
3. Clarify that JWT tokens handle all session management
4. Align code with RFC 9497 best practices
5. Improve code maintainability and clarity
6. Remove all deprecated/broken code

The changes are straightforward because:
- Greenfield application with no production deployments
- No backwards compatibility concerns
- No API changes (session_key was never actually used)
- No database changes
- No changes to OPAQUE protocol itself
- Only removing unused code and clarifying architecture
- JWT token management unchanged
- Focus on clean, compilable, correct code

## Success Criteria

Implementation is complete when:
1. ✅ All TypeScript code compiles without errors
2. ✅ All Go code compiles without errors
3. ✅ No references to "session_key" remain in codebase (except in comments explaining its removal)
4. ✅ Export key is properly discarded immediately after OPAQUE finalization
5. ✅ Code is clean, well-commented, and follows RFC 9497 architecture
6. ✅ `go fmt` and `go vet` pass without issues
